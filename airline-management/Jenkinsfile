pipeline {
    agent any
    
    environment {
        AWS_EC2_IP = 'ec2-3-15-235-93.us-east-2.compute.amazonaws.com'
        AWS_SSH_USER = 'ec2-user'
    }
    
    stages {
        stage('Checkout') {
            steps {
                checkout scm
            }
        }
        
        stage('Build with Maven') {
            agent {
                docker {
                    image 'maven:3.8.6-eclipse-temurin-17'
                    args '-v /c/Users/jenkins/.m2:/root/.m2'  // Adjusted for Windows
                    reuseNode true  // Important for Windows
                }
            }
            steps {
                bat 'mvn clean package'
            }
        }
        
        stage('Test') {
            agent {
                docker {
                    image 'maven:3.8.6-eclipse-temurin-17'
                    args '-v /c/Users/jenkins/.m2:/root/.m2'
                    reuseNode true
                }
            }
            steps {
                bat 'mvn test'
            }
            post {
                always {
                    junit 'target/surefire-reports/**/*.xml'
                }
            }
        }
        
        stage('Deploy to EC2') {
            steps {
                script {
                    sshagent(['ec2-ssh-key']) {
                        bat """
                            scp -o StrictHostKeyChecking=no target/*.jar %AWS_SSH_USER%@%AWS_EC2_IP%:/home/%AWS_SSH_USER%/
                            ssh -o StrictHostKeyChecking=no %AWS_SSH_USER%@%AWS_EC2_IP% "pgrep -f airline-management | xargs kill -9 || true"
                            ssh -o StrictHostKeyChecking=no %AWS_SSH_USER%@%AWS_EC2_IP% "nohup java -jar /home/%AWS_SSH_USER%/*.jar > /home/%AWS_SSH_USER%/app.log 2>&1 &"
                        """
                    }
                }
            }
        }
    }
    
    post {
        failure {
            emailext body: 'Pipeline failed. Please check: ${BUILD_URL}',
                    subject: 'Pipeline Failed: ${JOB_NAME} - Build #${BUILD_NUMBER}',
                    to: 'your-email@example.com'
        }
    }
}